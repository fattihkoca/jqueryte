/*!
 * http://jqueryte.com
 * jQuery TE 1.3.6
 * Copyright (C) 2012, Fatih Koca (fattih@fattih.com), AUTHOR.txt (http://jqueryte.com/about)
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.
This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
You should have received a copy of the GNU General Public License along with this library; if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 *
*/
(function(e){e.fn.jqte=function(t){function f(e,t,n,r,i){var s=a.length+1;return a.push({name:e,cls:s,command:t,key:n,tag:r,emphasis:i})}var n=[{title:"Font Size"},{title:"Color"},{title:"Bold",hotkey:"B"},{title:"Italic",hotkey:"I"},{title:"Underline",hotkey:"U"},{title:"Ordered List",hotkey:"."},{title:"Unordered List",hotkey:","},{title:"Subscript",hotkey:"down arrow"},{title:"Superscript",hotkey:"up arrow"},{title:"Outdent",hotkey:"left arrow"},{title:"Indent",hotkey:"right arrow"},{title:"Justify Left"},{title:"Justify Center"},{title:"Justify Right"},{title:"Strike Through",hotkey:"K"},{title:"Add Link",hotkey:"L"},{title:"Remove Link"},{title:"Cleaner Style",hotkey:"Delete"},{title:"Horizontal Rule",hotkey:"H"},{title:"Source"}];var r=["10","12","16","18","20","24","28"];var i=["0,0,0","68,68,68","102,102,102","153,153,153","204,204,204","238,238,238","243,243,243","255,255,255",null,"255,0,0","255,153,0","255,255,0","0,255,0","0,255,255","0,0,255","153,0,255","255,0,255",null,"244,204,204","252,229,205","255,242,204","217,234,211","208,224,227","207,226,243","217,210,233","234,209,220","234,153,153","249,203,156","255,229,153","182,215,168","162,196,201","159,197,232","180,167,214","213,166,189","224,102,102","246,178,107","255,217,102","147,196,125","118,165,175","111,168,220","142,124,195","194,123,160","204,0,0","230,145,56","241,194,50","106,168,79","69,129,142","61,133,198","103,78,167","166,77,121","153,0,0","180,95,6","191,144,0","56,118,29","19,79,92","11,83,148","53,28,117","116,27,71","102,0,0","120,63,4","127,96,0","39,78,19","12,52,61","7,55,99","32,18,77","76,17,48"];var s=["Web Address","E-mail Address","Picture URL"];var o=e.extend({status:true,css:"jqte",title:true,titletext:n,button:"OK",fsize:true,fsizes:r,funit:"px",color:true,linktypes:s,b:true,i:true,u:true,ol:true,ul:true,sub:true,sup:true,outdent:true,indent:true,left:true,center:true,right:true,strike:true,link:true,unlink:true,remove:true,rule:true,source:true,placeholder:false,br:true,p:true,change:"",focus:"",blur:""},t);e.fn.jqteVal=function(t){e(this).closest("."+o.css).find("."+o.css+"_editor").html(t)};var u=navigator.userAgent.toLowerCase();if(/msie [1-7]./.test(u))o.title=false;var a=[];f("fsize","fSize","","",false);f("color","colors","","",false);f("b","Bold","B",["b","strong"],true);f("i","Italic","I",["i","em"],true);f("u","Underline","U",["u"],true);f("ol","insertorderedlist","¾",["ol"],true);f("ul","insertunorderedlist","¼",["ul"],true);f("sub","subscript","(",["sub"],true);f("sup","superscript","&",["sup"],true);f("outdent","outdent","%",["blockquote"],false);f("indent","indent","'",["blockquote"],true);f("left","justifyLeft","","",false);f("center","justifyCenter","","",false);f("right","justifyRight","","",false);f("strike","strikeThrough","K",["strike"],true);f("link","linkcreator","L",["a"],true);f("unlink","unlink","",["a"],false);f("remove","removeformat",".","",false);f("rule","inserthorizontalrule","H",["hr"],false);f("source","displaysource","","",false);return this.each(function(){function D(){if(window.getSelection){return window.getSelection()}else if(document.selection&&document.selection.createRange&&document.selection.type!="None"){return document.selection.createRange()}}function P(e,t){var n,r=D();if(window.getSelection){if(r.anchorNode&&r.getRangeAt)n=r.getRangeAt(0);if(n){r.removeAllRanges();r.addRange(n)}if(!u.match(/msie/))document.execCommand("StyleWithCSS",false,false);document.execCommand(e,false,t)}else if(document.selection&&document.selection.createRange&&document.selection.type!="None"){n=document.selection.createRange();n.execCommand(e,false,t)}j(false,false)}function H(t,n,r){if(p.not(":focus"))p.focus();if(window.getSelection){var i=D(),s,o,u;if(i.anchorNode&&i.getRangeAt){s=i.getRangeAt(0);o=document.createElement(t);e(o).attr(n,r);u=s.extractContents();o.appendChild(u);s.insertNode(o);i.removeAllRanges();if(n=="style")j(e(o),r);else j(e(o),false)}}else if(document.selection&&document.selection.createRange&&document.selection.type!="None"){var a=document.selection.createRange();var f=a.htmlText;var l="<"+t+" "+n+'="'+r+'">'+f+"</"+t+">";document.selection.createRange().pasteHTML(l)}}function j(e,t){var n=B();n=n?n:e;if(n&&t==false){if(n.parent().is("[style]"))n.attr("style",n.parent().attr("style"));if(n.is("[style]"))n.find("*").attr("style",n.attr("style"))}else if(e&&t&&e.is("[style]")){var r=t.split(";");r=r[0].split(":");if(e.is("[style*="+r[0]+"]"))e.find("*").css(r[0],r[1]);F(e)}}function F(t){if(t){var t=t[0];if(document.body.createTextRange){var n=document.body.createTextRange();n.moveToElementText(t);n.select()}else if(window.getSelection){var r=window.getSelection();var n=document.createRange();if(t!="undefined"&&t!=null){n.selectNodeContents(t);r.removeAllRanges();r.addRange(n);if(e(t).is(":empty")){e(t).append(" ");F(e(t))}}}}}function I(){if(!c.data("sourceOpened")){var t=B();var n="http://";R(true);if(t){var r=t.prop("tagName").toLowerCase();if(r=="a"&&t.is("[href]")){n=t.attr("href");t.attr(w,"")}else H("a",w,"")}else m.val(n).focus();v.click(function(t){if(e(t.target).hasClass(o.css+"_linktypetext")||e(t.target).hasClass(o.css+"_linktypearrow"))U(true)});y.find("a").click(function(){var t=e(this).attr(o.css+"-linktype");y.data("linktype",t);b.find("."+o.css+"_linktypetext").html(y.find("a:eq("+y.data("linktype")+")").text());z(n);U()});z(n);m.focus().val(n).bind("keypress keyup",function(e){if(e.keyCode==13){q(l.find("["+w+"]"));return false}});g.click(function(){q(l.find("["+w+"]"))})}else R(false)}function q(t){m.focus();F(t);t.removeAttr(w);if(y.data("linktype")!="2")P("createlink",m.val());else{P("insertImage",m.val());p.find("img").each(function(){var t=e(this).prev("a");var n=e(this).next("a");if(t.length>0&&t.html()=="")t.remove();else if(n.length>0&&n.html()=="")n.remove()})}R();Q()}function R(e){V("["+w+"]:not([href])");l.find("["+w+"][href]").removeAttr(w);if(e){c.data("linkOpened",true);h.show()}else{c.data("linkOpened",false);h.hide()}U()}function U(e){if(e)y.show();else y.hide()}function z(e){var t=y.data("linktype");if(t=="1"&&(m.val()=="http://"||m.is("[value^=http://]")||!m.is("[value^=mailto]")))m.val("mailto:");else if(t!="1"&&!m.is("[value^=http://]"))m.val("http://");else m.val(e)}function W(t){if(!c.data("sourceOpened")){if(t=="fSize")styleField=M;else if(t=="colors")styleField=_;X(styleField,true);styleField.find("a").click(function(){var n=e(this).attr(o.css+"-styleval");if(t=="fSize"){styleType="font-size";n=n+o.funit}else if(t=="colors"){styleType="color";n="rgb("+n+")"}var r=J(styleType);H("span","style",styleType+":"+n+";"+r);X("",false);e("."+o.css+"_title").remove();Q()})}else X(styleField,false);R(false)}function X(e,t){var n="",r=[{d:"fsizeOpened",f:M},{d:"cpallOpened",f:_}];if(e!=""){for(var i=0;i<r.length;i++){if(e==r[i]["f"])n=r[i]}}if(t){c.data(n["d"],true);n["f"].slideDown(100);for(var i=0;i<r.length;i++){if(n["d"]!=r[i]["d"]){c.data(r[i]["d"],false);r[i]["f"].slideUp(100)}}}else{for(var i=0;i<r.length;i++){c.data(r[i]["d"],false);r[i]["f"].slideUp(100)}}}function V(t){l.find(t).each(function(){e(this).before(e(this).html()).remove()})}function J(e){var t=B();if(t&&t.is("[style]")&&t.css(e)!=""){var n=t.css(e);t.css(e,"");var r=t.attr("style");t.css(e,n);return r}else return""}function K(e){var t,n,r;t=e.replace(/\n/g,"").replace(/\r/g,"").replace(/\t/g,"").replace(/ /g," ");n=[/\<div>(.*?)\<\/div>/ig,/\<strong>(.*?)\<\/strong>/ig,/\<em>(.*?)\<\/em>/ig];r=["<p>$1</p>","<b>$1</b>","<i>$1</i>"];for(var i=0;i<n.length;i++){t=t.replace(n[i],r[i])}if(!o.p)t=t.replace(/\<p>(.*?)\<\/p>/ig,"<br/>$1");if(!o.br){n=[/\<br>(.*?)/ig,/\<br\/>(.*?)/ig];r=["<p>$1</p>","<p>$1</p>"];for(var i=0;i<n.length;i++){t=t.replace(n[i],r[i])}}if(!o.p&&!o.br)t=t.replace(/\<p>(.*?)\<\/p>/ig,"<div>$1</div>");return t}function Q(){var e=p.text()==""&&p.html().length<12?"":p.html();r.val(K(e))}function G(){p.html(K(r.val()))}function Y(t){var n=false,r=B(),i;if(r){e.each(t,function(t,s){i=r.prop("tagName").toLowerCase();if(i==s)n=true;else{r.parents().each(function(){i=e(this).prop("tagName").toLowerCase();if(i==s)n=true})}});return n}else return false}function Z(t){for(var n=0;n<a.length;n++){if(o[a[n].name]&&a[n].emphasis&&a[n].tag!="")Y(a[n].tag)?c.find("."+o.css+"_tool_"+a[n].cls).addClass(d):e("."+o.css+"_tool_"+a[n].cls).removeClass(d);X("",false)}}if(!e(this).data("jqte")||e(this).data("jqte")==null||e(this).data("jqte")=="undefined")e(this).data("jqte",true);else e(this).data("jqte",false);if(!o.status||!e(this).data("jqte")){if(e(this).closest("."+o.css).length>0){var t=e(this).closest("."+o.css).find("."+o.css+"_editor").html();e(this).is("[value]")?e(this).val(t):e(this).html(t);var n=e(this).closest("."+o.css).find("textarea").clone();e(this).closest("."+o.css).before(n).remove();e(this).data("jqte",false)}return}var r=e(this);var s=r.prop("tagName").toLowerCase();var f=e(this).is("[value]")||s=="textarea"?e(this).val():e(this).html();r.after('<div class="'+o.css+'"></div>');var l=r.next("."+o.css);l.html('<div class="'+o.css+"_toolbar"+'" role="toolbar" unselectable></div><div class="'+o.css+'_linkform" style="display:none" role="dialog"></div><div class="'+o.css+"_editor"+'"></div>');var c=l.find("."+o.css+"_toolbar");var h=l.find("."+o.css+"_linkform");var p=l.find("."+o.css+"_editor");var d=o.css+"_tool_depressed";h.append('<div class="'+o.css+'_linktypeselect" unselectable></div> <input class="'+o.css+'_linkinput" type="text/css" value=""> <div class="'+o.css+'_linkbutton" unselectable>'+o.button+'</div> <div style="height:1px;float:none;clear:both"></div>');var v=h.find("."+o.css+"_linktypeselect");var m=h.find("."+o.css+"_linkinput");var g=h.find("."+o.css+"_linkbutton");v.append('<div class="'+o.css+'_linktypeview" unselectable></div><div class="'+o.css+'_linktypes" role="menu" unselectable></div>');var y=v.find("."+o.css+"_linktypes");var b=v.find("."+o.css+"_linktypeview");var w=o.css+"-setlink";p.after('<div class="'+o.css+"_source "+o.css+'_hiddenField"></div>');var E=l.find("."+o.css+"_source");r.appendTo(E);if(s!="textarea"){var S="";e(r[0].attributes).each(function(){if(this.nodeName!="type"&&this.nodeName!="value")S=S+" "+this.nodeName+'="'+this.nodeValue+'"'});r.replaceWith("<textarea "+S+">"+f+"</textarea>");r=E.find("textarea")}p.attr("contenteditable","true").html(f);for(var x=0;x<a.length;x++){if(o[a[x].name]){var T=a[x].key.length>0?o.titletext[x].hotkey!=null&&o.titletext[x].hotkey!="undefined"&&o.titletext[x].hotkey!=""?" (Ctrl+"+o.titletext[x].hotkey+")":"":"";var N=o.titletext[x].title!=null&&o.titletext[x].title!="undefined"&&o.titletext[x].title!=""?o.titletext[x].title+T:"";c.append('<div class="'+o.css+"_tool "+o.css+"_tool_"+a[x].cls+'" role="button" data-tool="'+x+'" unselectable><a class="'+o.css+'_tool_icon" unselectable></a></div>');c.find("."+o.css+"_tool[data-tool="+x+"]").data({tag:a[x].tag,command:a[x].command,emphasis:a[x].emphasis,title:N});if(a[x].name=="fsize"){c.find("."+o.css+"_tool_"+a[x].cls).append('<div class="'+o.css+'_fontsizes" unselectable></div>');for(var C=0;C<o.fsizes.length;C++){c.find("."+o.css+"_fontsizes").append("<a "+o.css+'-styleval="'+o.fsizes[C]+'" class="'+o.css+"_fontsize"+'" style="font-size:'+o.fsizes[C]+o.funit+'" role="menuitem" unselectable>Abcdefgh...</a>')}}else if(a[x].name=="color"){c.find("."+o.css+"_tool_"+a[x].cls).append('<div class="'+o.css+'_cpalette" unselectable></div>');for(var k=0;k<i.length;k++){if(i[k]!=null)c.find("."+o.css+"_cpalette").append("<a "+o.css+'-styleval="'+i[k]+'" class="'+o.css+"_color"+'" style="background-color: rgb('+i[k]+')" role="gridcell" unselectable></a>');else c.find("."+o.css+"_cpalette").append('<div class="'+o.css+"_colorSeperator"+'"></div>')}}}}y.data("linktype","0");for(var x=0;x<3;x++){y.append("<a "+o.css+'-linktype="'+x+'" unselectable>'+o.linktypes[x]+"</a>");b.html('<div class="'+o.css+'_linktypearrow" unselectable></div><div class="'+o.css+'_linktypetext">'+y.find("a:eq("+y.data("linktype")+")").text()+"</div>")}var L="";if(/msie/.test(u))L="-ms-";else if(/chrome/.test(u)||/safari/.test(u)||/yandex/.test(u))L="-webkit-";else if(/mozilla/.test(u))L="-moz-";else if(/opera/.test(u))L="-o-";else if(/konqueror/.test(u))L="-khtml-";if(o.placeholder&&o.placeholder!=""){l.prepend('<div class="'+o.css+'_placeholder" unselectable><div class="'+o.css+'_placeholder_text">'+o.placeholder+"</div></div>");var A=l.find("."+o.css+"_placeholder");A.click(function(){p.focus()})}l.find("[unselectable]").css(L+"user-select","none").attr("unselectable","on").on("selectstart mousedown",function(e){e.preventDefault()});var O=c.find("."+o.css+"_tool");var M=c.find("."+o.css+"_fontsizes");var _=c.find("."+o.css+"_cpalette");var B=function(){var t,n;if(window.getSelection){n=getSelection();t=n.anchorNode}if(!t&&document.selection&&document.selection.createRange&&document.selection.type!="None"){n=document.selection;var r=n.getRangeAt?n.getRangeAt(0):n.createRange();t=r.commonAncestorContainer?r.commonAncestorContainer:r.parentElement?r.parentElement():r.item(0)}if(t){return t.nodeName=="#text"?e(t.parentNode):e(t)}else return false};O.click(function(t){if(e(this).data("command")=="displaysource"&&!c.data("sourceOpened")){c.find("."+o.css+"_tool").addClass(o.css+"_hiddenField");e(this).removeClass(o.css+"_hiddenField");c.data("sourceOpened",true);r.css("height",p.outerHeight());E.removeClass(o.css+"_hiddenField");p.addClass(o.css+"_hiddenField");r.focus();Q();R(false);X("",false);if(o.placeholder&&o.placeholder!="")A.hide()}else{if(!c.data("sourceOpened")){if(e(this).data("command")=="linkcreator"){if(!c.data("linkOpened"))I();else{R(false)}}else if(e(this).data("command")=="fSize"||e(this).data("command")=="colors"){if(e(this).data("command")=="fSize"&&!e(t.target).hasClass(o.css+"_fontsize")||e(this).data("command")=="colors"&&!e(t.target).hasClass(o.css+"_color"))W(e(this).data("command"))}else{if(p.not(":focus"))p.focus();P(e(this).data("command"),null);R(false);X("",false);e(this).data("emphasis")==true&&!e(this).hasClass(d)?e(this).addClass(d):e(this).removeClass(d);E.addClass(o.css+"_hiddenField");p.removeClass(o.css+"_hiddenField");Q()}}else{c.data("sourceOpened",false);c.find("."+o.css+"_tool").removeClass(o.css+"_hiddenField");E.addClass(o.css+"_hiddenField");p.removeClass(o.css+"_hiddenField");if(p.not(":focus"))p.focus()}if(o.placeholder&&o.placeholder!="")p.html()!=""?A.hide():A.show()}}).hover(function(t){if(o.title&&e(this).data("title")!=""&&(e(t.target).hasClass(o.css+"_tool")||e(t.target).hasClass(o.css+"_tool_icon"))){e("."+o.css+"_title").remove();l.append('<div class="'+o.css+'_title"><div class="'+o.css+'_titleArrow"><div class="'+o.css+'_titleArrowIcon"></div></div><div class="'+o.css+'_titleText">'+e(this).data("title")+"</div></div>");var n=e("."+o.css+"_title:first");var r=n.find("."+o.css+"_titleArrowIcon");var i=e(this).position();var s=i.left+e(this).outerWidth()-n.outerWidth()/2-e(this).outerWidth()/2;var u=i.top+e(this).outerHeight()+5;n.delay(400).css({top:u,left:s}).fadeIn(200)}},function(){e("."+o.css+"_title").remove()});p.bind("keypress keyup keydown drop cut copy paste DOMCharacterDataModified DOMSubtreeModified",function(){if(!c.data("sourceOpened"))e(this).trigger("change");U();if(e.isFunction(o.change))o.change();if(o.placeholder&&o.placeholder!="")e(this).text()!=""?A.hide():A.show()}).bind("change",function(){if(!c.data("sourceOpened"))setTimeout(Q,0)}).keydown(function(e){if(e.ctrlKey){for(var t=0;t<a.length;t++){if(o[a[t].name]&&e.keyCode==a[t].key.charCodeAt(0)){if(a[t].command!=""&&a[t].command!="linkcreator")P(a[t].command,null);else if(a[t].command=="linkcreator")I();return false}}}}).bind("mouseup keyup",Z).focus(function(){U();if(e.isFunction(o.focus))o.focus();l.addClass(o.css+"_focused")}).focusout(function(){O.removeClass(d);X("",false);U();if(e.isFunction(o.blur))o.blur();l.removeClass(o.css+"_focused")});r.bind("keydown keyup",function(){setTimeout(G,0);e(this).height(e(this)[0].scrollHeight);if(e(this).val()=="")e(this).height(0)}).focus(function(){l.addClass(o.css+"_focused")}).focusout(function(){l.removeClass(o.css+"_focused")})})}})(jQuery);